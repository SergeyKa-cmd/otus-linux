
# OTUS Linux admin course

## Networking

### How to use this repo

Clone repo,  run `vagrant up`. Vagrant will build seven machines. Be patient it can take long time. 

```
$> vagrant status
Current machine states:

inetRouter                running (virtualbox)
centralRouter             running (virtualbox)
office1Router             running (virtualbox)
office2Router             running (virtualbox)
centralServer             running (virtualbox)
office1Server             running (virtualbox)
office2Server             running (virtualbox)
```
![alt text](net-hw.jpg?raw=true)

### Important notice

Check that Default router pressent and IS NOT `10.0.2.* dev eth0`. If this happend run `systemctl restart network` and get like this:
```
[root@office1Server vagrant]# ip route 
default via 192.168.2.193 dev eth1 proto static metric 103 
10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100 
192.168.2.192/26 dev eth1 proto kernel scope link src 192.168.2.194 metric 103 

```

### Nets 

| Net name      | Net               | broadcast     | Hosts |
| ------------- | ----------------- | ------------- | ----- |
| directors     | 192.168.0.0/28    | 192.168.0.15  | 14    |
| free net      | 192.168.0.16/28   | 192.168.0.31  | 14    |
| office hw     | 192.168.0.32/28   | 192.168.0.47  | 14    |
| free net      | 192.168.0.48/28   | 192.168.0.63  | 14    |
| ------------- | ----------------- | ------------- | ----- |
| wifi          | 192.168.0.64/26   | 192.168.0.127 | 62    |
| free net      | 192.168.0.128/26  | 192.168.0.191 | 62    |
| ------------- | ----------------- | ------------- | ----- |
| dev2          | 192.168.1.0/25    | 192.168.1.127 | 126   |
| test servers2 | 192.168.1.128/26  | 192.168.1.191 | 62    |
| office hw2    | 192.168.1.192/26  | 192.168.1.255 | 62    |
| ------------- | ----------------- | ------------- | ----- |
| dev1          | 192.168.2.0/26    | 192.168.2.63  | 62    |
| test servers1 | 192.168.2.64/26   | 192.168.2.127 | 62    |
| managers1     | 192.168.2.128/26  | 192.168.2.191 | 62    |
| office hw1    | 192.168.2.192/26  | 192.168.2.255 | 62    |

### Check routes

#### Ping and trace inet router from office1Server

```
[root@office1Server vagrant]# ping 192.168.255.1
PING 192.168.255.1 (192.168.255.1) 56(84) bytes of data.
64 bytes from 192.168.255.1: icmp_seq=1 ttl=62 time=2.79 ms
64 bytes from 192.168.255.1: icmp_seq=2 ttl=62 time=3.00 ms
^C
--- 192.168.255.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 2.792/2.897/3.003/0.118 ms

[root@office1Server vagrant]# tracepath -n  192.168.255.1
 1?: [LOCALHOST]                                         pmtu 1500
 1:  192.168.2.193                                         1.462ms 
 1:  192.168.2.193                                         1.132ms 
 2:  192.168.0.17                                          2.365ms 
 3:  192.168.255.1                                         2.817ms reached
     Resume: pmtu 1500 hops 3 back 3 
```

#### Ping and tracerout internet adress 8.8.8.8 from office1Server

```
root@office1Server vagrant]# ping  8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=57 time=25.8 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=57 time=25.8 ms
^C

[root@office1Server vagrant]# tracepath -n  8.8.8.8
 1?: [LOCALHOST]                                         pmtu 1500
 1:  192.168.2.193                                         1.366ms 
 1:  192.168.2.193                                         1.284ms 
 2:  192.168.0.17                                          1.903ms 
 3:  192.168.255.1                                         2.803ms 
 4:  no reply
^C
```

### IP Tables

See rules
```
[root@inetRouter vagrant]# iptables -t nat -L -v -n
Chain PREROUTING (policy ACCEPT 52 packets, 16776 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   60 15960 MASQUERADE  all  --  *      eth0    0.0.0.0/0           !192.168.0.0/16      

Chain OUTPUT (policy ACCEPT 9 packets, 684 bytes)
 pkts bytes target     prot opt in     out     source               destination         
```

Save config
```
[root@inetRouter vagrant]# service iptables save
iptables: Saving firewall rules to /etc/sysconfig/iptables:[  OK  ]

[root@inetRouter vagrant]# cat /etc/sysconfig/iptables
# Generated by iptables-save v1.4.7 on Sun Oct 20 16:21:06 2019
*nat
:PREROUTING ACCEPT [33:15332]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [4:304]
-A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE 
COMMIT
# Completed on Sun Oct 20 16:21:06 2019

```

### Links 

https://www.calculator.net/ip-subnet-calculator.html

https://subnet-calculator.samuraj-cz.com

https://hackertarget.com/tcpdump-examples/

---

https://fedoraproject.org/wiki/Networking/CLI

https://danielmiessler.com/study/tcpdump/

https://www.thegeekstuff.com/2010/08/tcpdump-command-examples

https://www.wireshark.org/docs/man-pages/tshark.html

https://hackertarget.com/tshark-tutorial-and-filter-examples/

https://www.hogarthuk.com/?q=node/8

https://www.opennet.ru/docs/RUS/tcpip/

--------------------------------------------------------------------

# Task description

## otus-linux
Vagrantfile - для стенда урока 9 - Network

## Дано
Vagrantfile с начальным  построением сети
inetRouter
centralRouter
centralServer

тестировалось на virtualbox

## Планируемая архитектура
построить следующую архитектуру

Сеть office1
- 192.168.2.0/26      - dev
- 192.168.2.64/26    - test servers
- 192.168.2.128/26  - managers
- 192.168.2.192/26  - office hardware

Сеть office2
- 192.168.1.0/25      - dev
- 192.168.1.128/26  - test servers
- 192.168.1.192/26  - office hardware


Сеть central
- 192.168.0.0/28    - directors
- 192.168.0.32/28  - office hardware
- 192.168.0.64/26  - wifi

```
Office1 ---\
      -----> Central --IRouter --> internet
Office2----/
```
Итого должны получится следующие сервера
- inetRouter
- centralRouter
- office1Router
- office2Router
- centralServer
- office1Server
- office2Server

## Теоретическая часть
- Найти свободные подсети
- Посчитать сколько узлов в каждой подсети, включая свободные
- Указать broadcast адрес для каждой подсети
- проверить нет ли ошибок при разбиении

## Практическая часть
- Соединить офисы в сеть согласно схеме и настроить роутинг
- Все сервера и роутеры должны ходить в инет черз inetRouter
- Все сервера должны видеть друг друга
- у всех новых серверов отключить дефолт на нат (eth0), который вагрант поднимает для связи
- при нехватке сетевых интервейсов добавить по несколько адресов на интерфейс
