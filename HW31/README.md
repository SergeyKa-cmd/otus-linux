# OTUS Linux admin course

## PostgreSQL cluster (Patroni Consul)

### How to use this repo

Patroni cluster demo stend from https://gitlab.com/otus_linux/patroni

Run:

```
vagrant up
ansible-playbook site.yml -i hosts
```

Consul UI: `192.168.11.100:8500`

![Consul](./consul.png?raw=true "Consul web")

### Stend config

#### Patroni

* Check patroni cluster status 
```
root@pg1:~# patronictl -c /etc/patroni/patroni.yml list
+---------+--------+----------------+--------+---------+----+-----------+
| Cluster | Member |      Host      |  Role  |  State  | TL | Lag in MB |
+---------+--------+----------------+--------+---------+----+-----------+
|   otus  |  pg1   | 192.168.11.120 |        | running |  3 |       0.0 |
|   otus  |  pg2   | 192.168.11.121 | Leader | running |  3 |           |
|   otus  |  pg3   | 192.168.11.122 |        | running |  3 |       0.0 |
+---------+--------+----------------+--------+---------+----+-----------+

root@pg1:~# curl http://192.168.11.120:8008/patroni
{"database_system_identifier": "6772990090924931235", "postmaster_start_time": "2019-12-21 20:43:03.517 UTC", "timeline": 3, "cluster_unlocked": false, "patroni": {"scope": "otus", "version": "1.6.3"}, "state": "running", "role": "replica", "xlog": {"received_location": 134217824, "replayed_timestamp": null, "paused": false, "replayed_location": 134217824}, "server_version": 110006}
root@pg1:~# curl http://192.168.11.121:8008/patroni
{"database_system_identifier": "6772990090924931235", "postmaster_start_time": "2019-12-21 20:42:51.564 UTC", "timeline": 3, "cluster_unlocked": false, "patroni": {"scope": "otus", "version": "1.6.3"}, "replication": [{"sync_state": "async", "sync_priority": 0, "client_addr": "192.168.11.122", "state": "streaming", "application_name": "pg3", "usename": "replicator"}, {"sync_state": "async", "sync_priority": 0, "client_addr": "192.168.11.120", "state": "streaming", "application_name": "pg1", "usename": "replicator"}], "state": "running", "role": "master", "xlog": {"location": 134217824}, "server_version": 110006}
```

* Switchover
```
root@pg1:~# patronictl -c /etc/patroni/patroni.yml switchover
Master [pg2]: 
Candidate ['pg1', 'pg3'] []: 
When should the switchover take place (e.g. 2019-12-21T21:45 )  [now]: 
Current cluster topology
+---------+--------+----------------+--------+---------+----+-----------+
| Cluster | Member |      Host      |  Role  |  State  | TL | Lag in MB |
+---------+--------+----------------+--------+---------+----+-----------+
|   otus  |  pg1   | 192.168.11.120 |        | running |  3 |       0.0 |
|   otus  |  pg2   | 192.168.11.121 | Leader | running |  3 |           |
|   otus  |  pg3   | 192.168.11.122 |        | running |  3 |       0.0 |
+---------+--------+----------------+--------+---------+----+-----------+
Are you sure you want to switchover cluster otus, demoting current master pg2? [y/N]: y
2019-12-21 20:45:09.16873 Successfully switched over to "pg1"
+---------+--------+----------------+--------+---------+----+-----------+
| Cluster | Member |      Host      |  Role  |  State  | TL | Lag in MB |
+---------+--------+----------------+--------+---------+----+-----------+
|   otus  |  pg1   | 192.168.11.120 | Leader | running |  3 |           |
|   otus  |  pg2   | 192.168.11.121 |        | stopped |    |   unknown |
|   otus  |  pg3   | 192.168.11.122 |        | running |    |   unknown |
+---------+--------+----------------+--------+---------+----+-----------+
root@pg1:~# patronictl -c /etc/patroni/patroni.yml list
+---------+--------+----------------+--------+---------+----+-----------+
| Cluster | Member |      Host      |  Role  |  State  | TL | Lag in MB |
+---------+--------+----------------+--------+---------+----+-----------+
|   otus  |  pg1   | 192.168.11.120 | Leader | running |  4 |           |
|   otus  |  pg2   | 192.168.11.121 |        | running |  4 |       0.0 |
|   otus  |  pg3   | 192.168.11.122 |        | running |  4 |       0.0 |
+---------+--------+----------------+--------+---------+----+-----------+
```

On slave nodes recovery file created automaticaly
```
root@pg3:~# cat /var/data/base/recovery.conf
# Do not edit this file manually!
# It will be overwritten by Patroni!
primary_conninfo = 'user=replicator passfile=/tmp/.pgpass host=192.168.11.120 port=5432 sslmode=prefer application_name=pg3'
primary_slot_name = 'pg3'
recovery_target_timeline = 'latest'
standby_mode = 'on'
```

* Failover
```
root@pg1:~# patronictl -c /etc/patroni/patroni.yml failover
Candidate ['pg2', 'pg3'] []: pg3
Current cluster topology
+---------+--------+----------------+--------+---------+----+-----------+
| Cluster | Member |      Host      |  Role  |  State  | TL | Lag in MB |
+---------+--------+----------------+--------+---------+----+-----------+
|   otus  |  pg1   | 192.168.11.120 | Leader | running |  6 |           |
|   otus  |  pg2   | 192.168.11.121 |        | running |  6 |       0.0 |
|   otus  |  pg3   | 192.168.11.122 |        | running |  6 |       0.0 |
+---------+--------+----------------+--------+---------+----+-----------+
Are you sure you want to failover cluster otus, demoting current master pg1? [y/N]: y
2019-12-21 20:48:08.13255 Successfully failed over to "pg3"
+---------+--------+----------------+--------+---------+----+-----------+
| Cluster | Member |      Host      |  Role  |  State  | TL | Lag in MB |
+---------+--------+----------------+--------+---------+----+-----------+
|   otus  |  pg1   | 192.168.11.120 |        | stopped |    |   unknown |
|   otus  |  pg2   | 192.168.11.121 |        | running |  6 |       0.0 |
|   otus  |  pg3   | 192.168.11.122 | Leader | running |  6 |           |
+---------+--------+----------------+--------+---------+----+-----------+

root@pg1:~# patronictl -c /etc/patroni/patroni.yml list
+---------+--------+----------------+--------+---------+----+-----------+
| Cluster | Member |      Host      |  Role  |  State  | TL | Lag in MB |
+---------+--------+----------------+--------+---------+----+-----------+
|   otus  |  pg1   | 192.168.11.120 |        | running |  7 |       0.0 |
|   otus  |  pg2   | 192.168.11.121 |        | running |  7 |       0.0 |
|   otus  |  pg3   | 192.168.11.122 | Leader | running |  7 |           |
+---------+--------+----------------+--------+---------+----+-----------+
```

#### Check replication (password in patroni.yml)

* On leader(master) node
```
root@pg1:~# sudo -u postgres psql -h 192.168.11.120
Password for user postgres: 
psql (11.6 (Ubuntu 11.6-1.pgdg18.04+1))
Type "help" for help.

postgres=# CREATE DATABASE test_db ENCODING='UTF8';
CREATE DATABASE
postgres=# \c test_db
You are now connected to database "test_db" as user "postgres".
test_db=# CREATE TABLE companies (name varchar(80));
CREATE TABLE
test_db=# INSERT INTO companies VALUES ('Otus');
INSERT 0 1
test_db=# INSERT INTO companies VALUES ('Otus2');
INSERT 0 1
test_db=# 
```

* On slave node
```
root@pg2:~# sudo -u postgres psql -h 192.168.11.121
Password for user postgres: 
psql (11.6 (Ubuntu 11.6-1.pgdg18.04+1))
Type "help" for help.

postgres=# \l
                              List of databases
   Name    |  Owner   | Encoding | Collate |  Ctype  |   Access privileges   
-----------+----------+----------+---------+---------+-----------------------
 postgres  | postgres | UTF8     | C.UTF-8 | C.UTF-8 | 
 template0 | postgres | UTF8     | C.UTF-8 | C.UTF-8 | =c/postgres          +
           |          |          |         |         | postgres=CTc/postgres
 template1 | postgres | UTF8     | C.UTF-8 | C.UTF-8 | =c/postgres          +
           |          |          |         |         | postgres=CTc/postgres
 test_db   | postgres | UTF8     | C.UTF-8 | C.UTF-8 | 
(4 rows)

postgres=# \c test_db
You are now connected to database "test_db" as user "postgres".
test_db=# SELECT * FROM companies ;
 name  
-------
 Otus
 Otus2
(2 rows)

```

#### Add parametesr to PostgreSql config on pg3 using patroni

* Edit `/etc/patroni/patroni.yml`, add `shared_buffers = '256MB'` in `postgresql -> parameters` section
```
postgresql:
  listen: 192.168.11.122:5432
 ...
  parameters:
    unix_socket_directories: '.'
    shared_buffers = '256MB
```

* Reload patroni config
```
root@pg3:~# patronictl -c /etc/patroni/patroni.yml reload otus
+---------+--------+----------------+--------+---------+----+-----------+
| Cluster | Member |      Host      |  Role  |  State  | TL | Lag in MB |
+---------+--------+----------------+--------+---------+----+-----------+
|   otus  |  pg1   | 192.168.11.120 | Leader | running |  8 |           |
|   otus  |  pg2   | 192.168.11.121 |        | running |  8 |       0.0 |
|   otus  |  pg3   | 192.168.11.122 |        | running |  8 |       0.0 |
+---------+--------+----------------+--------+---------+----+-----------+
Are you sure you want to reload members pg2, pg3, pg1? [y/N]: y
Reload request received for member pg2 and will be processed within 10 seconds
Reload request received for member pg3 and will be processed within 10 seconds
Reload request received for member pg1 and will be processed within 10 seconds

# Check new parameter apears in server config

root@pg3:~# grep buf /var/data/base/postgresql.conf
shared_buffers = '256MB'
```

* Reinit postgres on pg3 server
```
root@pg3:~# patronictl -c /etc/patroni/patroni.yml reinit otus
+---------+--------+----------------+--------+---------+----+-----------+-----------------+
| Cluster | Member |      Host      |  Role  |  State  | TL | Lag in MB | Pending restart |
+---------+--------+----------------+--------+---------+----+-----------+-----------------+
|   otus  |  pg1   | 192.168.11.120 | Leader | running |  8 |           |                 |
|   otus  |  pg2   | 192.168.11.121 |        | running |  8 |       0.0 |                 |
|   otus  |  pg3   | 192.168.11.122 |        | running |  8 |       0.0 |        *        |
+---------+--------+----------------+--------+---------+----+-----------+-----------------+
Which member do you want to reinitialize [pg2, pg3, pg1]? []: pg3
Are you sure you want to reinitialize members pg3? [y/N]: y
Success: reinitialize for member pg3

```

* Check result:
```
root@pg3:~# sudo -u postgres psql -h 192.168.11.122
Password for user postgres: 
psql (11.6 (Ubuntu 11.6-1.pgdg18.04+1))
Type "help" for help.

postgres=# SHOW shared_buffers;
 shared_buffers 
----------------
 256MB            <-------!!!
(1 row)

```

### Troubleshooting


### Useful links

https://patroni.readthedocs.io/en/latest/

https://medium.com/searce/design-a-highly-available-postgresql-cluster-with-patroni-in-gcp-part-1-dfb6ed277806

https://www.opsdash.com/blog/postgres-getting-started-patroni.html

https://pgconf.ru/2019/242821

